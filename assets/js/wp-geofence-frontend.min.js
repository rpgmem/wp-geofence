(function(){'use strict';var doc=window.document,wpData=window.wpGeofenceData||{};function t(k){return window.wpGeofenceL10n&&window.wpGeofenceL10n[k]?window.wpGeofenceL10n[k]:{'no_support':'Your browser does not support geolocation.','precision_insufficient':'Precision insufficient:','cache_invalidated':'Position updated — access revoked.'}[k]||k}function hav(a,b,c,d){var R=6371e3,φ1=a*Math.PI/180,φ2=c*Math.PI/180,Δφ=(c-a)*Math.PI/180,Δλ=(d-b)*Math.PI/180;var x=Math.sin(Δφ/2)*Math.sin(Δφ/2)+Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)*Math.sin(Δλ/2);return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x))}function setSrcs(node){var ifs=node.querySelectorAll('iframe[data-src]');ifs.forEach(function(f){var s=f.getAttribute('data-src');if(s){f.setAttribute('src',s);f.removeAttribute('data-src')}})}function readCache(k){try{var r=localStorage.getItem(k);return r?JSON.parse(r):null}catch(e){return null}}function writeCache(k,v){try{localStorage.setItem(k,JSON.stringify({timestamp:Date.now(),coords:v}));}catch(e){} }document.addEventListener('DOMContentLoaded',function(){Object.keys(wpData).forEach(function(id){(function(i){try{var cfg=wpData[i];if(!cfg) return;var msg=doc.getElementById('geo_msg_'+i),wrap=doc.getElementById('geo_wrap_'+i);if(!msg||!wrap) return;var areas=Array.isArray(cfg.areas)?cfg.areas:[],lazy=cfg.lazyload==='yes',minAcc=Number(cfg.minAccuracy)||0,redirect=cfg.redirectURL||'',msgOut=cfg.msgOut||'',msgErr=cfg.msgError||'',globalCache=(cfg.cacheGlobalEnabled==='yes'),shortCache=(cfg.cacheEnabledShortcode==='yes'),cacheEnabled=globalCache||shortCache,cacheTTL=Number(cfg.cacheTTL)||60,cacheAcc=Number(cfg.cacheAccuracy)||50,cacheKey='wp_geofence_cache_'+i;function evaluate(pos,fromCache){var lat=pos.latitude,lon=pos.longitude,acc=pos.accuracy||1e6;if(minAcc>0&&acc>minAcc){msg.textContent=t('precision_insufficient')+' '+acc+'m';wrap.style.display='none';return false}var ok=!areas.length;for(var j=0;j<areas.length;j++){if(hav(lat,lon,areas[j].lat,areas[j].lng)<=areas[j].radius){ok=true;break}}if(ok){msg.style.display='none';wrap.style.display='block';try{wrap.dispatchEvent(new Event('geofence:show'))}catch(e){}if(lazy && !wrap.innerHTML.trim()){wrap.innerHTML=cfg.contentIframeSafe||cfg.contentSerialized||'';setSrcs(wrap);}return true}else{msg.textContent=msgOut;wrap.style.display='none';if(redirect)location.href=redirect;return false}}if(cacheEnabled){var cached=readCache(cacheKey);if(cached&&cached.coords){var age=(Date.now()-cached.timestamp)/1000;if(age<=cacheTTL&&cached.coords.accuracy<=cacheAcc){var used=evaluate({latitude:cached.coords.latitude,longitude:cached.coords.longitude,accuracy:cached.coords.accuracy},true);if(used&&lazy){wrap.innerHTML=cfg.contentIframeSafe||cfg.contentSerialized||'';setSrcs(wrap);}navigator.geolocation.getCurrentPosition(function(real){var rp={latitude:real.coords.latitude,longitude:real.coords.longitude,accuracy:real.coords.accuracy};var realOk=evaluate(rp,false);if(real.coords&&real.coords.accuracy<=cacheAcc)writeCache(cacheKey,rp);if(!realOk&&used)msg.textContent=t('cache_invalidated');},function(){}, {enableHighAccuracy:true,maximumAge:0,timeout:10000});return}}}if(!navigator.geolocation){msg.textContent=t('no_support');wrap.style.display='none';return}navigator.geolocation.getCurrentPosition(function(p){var pos={latitude:p.coords.latitude,longitude:p.coords.longitude,accuracy:p.coords.accuracy};if(cacheEnabled&&p.coords&&p.coords.accuracy<=cacheAcc)writeCache(cacheKey,pos);evaluate(pos,false);},function(){msg.textContent=msgErr;wrap.style.display='none';},{enableHighAccuracy:true,maximumAge:0,timeout:10000});}catch(e){console.error('WP Geofence',i,e);}})(id)});});})();